name: Django CI/CD - Webhook

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # 1. Job de Integração Contínua (CI - Testes)
  ci:
    runs-on: ubuntu-latest
    
    # Define o PYTHONPATH para que o Django encontre os módulos do projeto
    env:
      PYTHONPATH: ${{ github.workspace }}
      
    steps:
    - uses: actions/checkout@v4

    # Instala o git no runner (necessário para alguns comandos ou para a estrutura)
    - name: Install system dependencies (git)
      run: sudo apt-get update && sudo apt-get install -y git
      
    - name: Set up Python
      uses: actions/setup-python@v4 
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run Tests
      # Garante que os testes rodem sem erro de SECRET_KEY
      run: |
        export SECRET_KEY='ci-secret-key-para-testes'
        python manage.py test
      
  # 2. Job de Deployment (CD) - Roda somente se o CI for SUCESSO
  cd:
    needs: ci
    runs-on: ubuntu-latest
    
    # Este estágio apenas dispara o Webhook, que é o código Django no servidor
    steps:
    - name: Trigger PythonAnywhere Webhook for Deployment
      run: |
        curl -X POST \
        -H "Content-Type: application/json" \
        -d '{"ref": "refs/heads/${{ github.ref_name }}"}' \
        https://${{ secrets.PA_WEBAPP_DOMAIN }}/webhook/github/