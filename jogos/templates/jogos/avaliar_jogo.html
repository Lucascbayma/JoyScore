{% extends 'base.html' %}
{% load static %} 

{% block title %}avaliar - JoyScore{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'jogos/css/avaliar.css' %}"> 
{% endblock %}

{% block content %}
<section class="game-container">
    
    <div class="cover">
        <img src="{{jogo.background_image}}" alt="Capa do Jogo" id="game-cover">

        {% if esta_na_biblioteca %}
        <div class="jornada-container" id="jornada-container">
            
            <div class="jornada-display" {% if not jornada_existente %}style="display: none;"{% endif %}>
                <h3>Minha Jornada Gamer</h3>
                {% if jornada_existente %}
                    <div class="jornada-stat">
                        <strong>Horas Jogadas:</strong>
                        <span>{{ jornada_existente.horas_jogadas }}h</span>
                    </div>
                    <div class="jornada-stat">
                        <strong>Progresso de Troféus:</strong>
                        <span>{{ jornada_existente.trofeus_conquistados }} / {{ jornada_existente.trofeus_totais }}</span>
                    </div>
                    
                    <div class="jornada-progresso">
                        <div class="progresso-label">
                            Platina: {{ jornada_existente.porcentagem_conclusao }}%
                        </div>
                        <div class="progresso-barra-fundo">
                            {% with perc=jornada_existente.porcentagem_conclusao %}
                            <div 
                                class="progresso-barra-preenchimento 
                                {% if perc <= 25 %}
                                    cor-vermelha
                                {% elif perc == 100 %}
                                    cor-verde
                                {% endif %}
                                " 
                                style="width: {{ perc }}%;">
                            </div>
                            {% endwith %}
                        </div>
                    </div>
                    <button type="button" class="jornada-edit-btn" id="jornada-edit-btn">Editar</button>
                
                {% endif %}
            </div>

            <div class="jornada-form-wrapper" {% if jornada_existente %}style="display: none;"{% endif %}>
                
                {% if not jornada_existente %}
                    <h3>Minha Jornada Gamer</h3>
                {% endif %}

                {% if jornada_existente %}
                    <button type="button" class="jornada-close-btn" id="jornada-close-btn">×</button>
                {% endif %}
                
                <form class="jornada-form" method="POST">
                    {% csrf_token %}
                    
                    <div class="jornada-form-campo">
                        <label for="horas_jogadas">Quantas horas você jogou?</label>
                        <input type="number" name="horas_jogadas" id="horas_jogadas" 
                               value="{{ jornada_existente.horas_jogadas|default:0 }}" 
                               placeholder="Ex: 120" min="0">
                    </div>
                    
                    <div class="jornada-form-campo">
                        <label for="trofeus_totais">Quantos troféus o jogo tem no total?</label>
                        <input type="number" name="trofeus_totais" id="trofeus_totais" 
                               value="{{ jornada_existente.trofeus_totais|default:0 }}" 
                               placeholder="Ex: 50" min="0">
                    </div>

                    <div class="jornada-form-campo">
                        <label for="trofeus_conquistados">Quantos troféus você conquistou?</label>
                        <input type="number" name="trofeus_conquistados" id="trofeus_conquistados" 
                               value="{{ jornada_existente.trofeus_conquistados|default:0 }}" 
                               placeholder="Ex: 35" min="0">
                    </div>
                    
                    <button type="submit" name="acao" value="salvar_jornada" class="submit-jornada">
                        Salvar Jornada
                    </button>
                </form>
            </div>

        </div>
        {% endif %} </div>

    <div class="game-info">
        
        <div class="title-section">
            <h1 id="game-title">{{jogo.titulo}}</h1>
            
            <a href="{% url 'jogos:adicionar_biblioteca' jogo.id %}" 
               class="add-btn {% if esta_na_biblioteca %} added {% endif %}" 
               title="{% if esta_na_biblioteca %}Remover da biblioteca{% else %}Adicionar à biblioteca{% endif %}"
               aria-label="{% if esta_na_biblioteca %}Remover {{jogo.titulo}}{% else %}Adicionar {{jogo.titulo}}{% endif %}">
                
                <i class="fas {% if esta_na_biblioteca %}fa-check{% else %}fa-plus{% endif %}"></i>
            </a>

            </div>

        <dl class="details">
            <dt>Gênero:</dt>
            <dd id="game-genre">{{jogo.genero}}</dd>

            <dt>Desenvolvedor:</dt>
            <dd id="game-platforms">{{jogo.desenvolvedor}}</dd>
        </dl>
        
        <div class="description">
            <h2>Descrição</h2>
            <p id="game-description">
                {{jogo.descricao}}
            </p>
        </div>

        <section class="rating-section">
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <p class="message-{{ message.tags }}">{{ message }}</p>
                {% endfor %}
            </div>
            {% endif %}

            <h2>Avalie este jogo</h2>
            
            
            <form class="rating-form" method="POST">
                {% csrf_token %}
                
                <fieldset class="rating">
                    <legend class="sr-only">Avaliação de estrelas: 1 a 5</legend>

                    <input type="radio" id="star5" name="nota" value="5" aria-label="5 Estrelas" {% if avaliacao_existente.nota == 5 %}checked{% endif %}>
                    <label for="star5" class="star">★</label>
                    
                    <input type="radio" id="star4" name="nota" value="4" aria-label="4 Estrelas" {% if avaliacao_existente.nota == 4 %}checked{% endif %}>
                    <label for="star4" class="star">★</label>
                    
                    <input type="radio" id="star3" name="nota" value="3" aria-label="3 Estrelas" {% if avaliacao_existente.nota == 3 %}checked{% endif %}>
                    <label for="star3" class="star">★</label>
                    
                    <input type="radio" id="star2" name="nota" value="2" aria-label="2 Estrelas" {% if avaliacao_existente.nota == 2 %}checked{% endif %}>
                    <label for="star2" class="star">★</label>
                    
                    <input type="radio" id="star1" name="nota" value="1" aria-label="1 Estrela" {% if avaliacao_existente.nota == 1 %}checked{% endif %}>
                    <label for="star1" class="star">★</label>
                </fieldset>

                <div class="comment-field"> 
                    <label for="comment-text">Seu Comentário:</label> 
                    <textarea 
                        id="comment-text" 
                        name="comentario" 
                        rows="4" 
                        placeholder="Escreva sua avaliação sobre o jogo aqui!"
                    >{{avaliacao_existente.comentario|default:''}}</textarea>
                </div>
                
                <button type="submit" name="acao" value="salvar_avaliacao" class="submit-rating">Salvar Avaliação</button>

            </form>
        </section>
        
    </div>
    </section>

{% endblock content %}

{% block extra_scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const displayBlock = document.querySelector('.jornada-display');
            const formWrapper = document.querySelector('.jornada-form-wrapper');
            const editBtn = document.getElementById('jornada-edit-btn');
            const closeBtn = document.getElementById('jornada-close-btn');

            if (editBtn) {
                editBtn.addEventListener('click', function() {
                    displayBlock.style.display = 'none';
                    formWrapper.style.display = 'block';
                });
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    displayBlock.style.display = 'block';
                    formWrapper.style.display = 'none';
                });
            }
        });
    </script>
{% endblock %}